name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Version & Publish
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # full history for changesets/tags

      - name: üíø Setup pnpm (v9)
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: üß∞ Setup Node.js (v20) & npm registry cache
        uses: actions/setup-node@v5
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org/"
          cache: pnpm

      - name: ‚¨ÜÔ∏è Upgrade npm to latest
        run: |
          npm -v
          npm i -g npm@latest
          npm -v

      - name: ÔøΩ Cache Cypress binary
        id: cypress-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: üì¶ Install dependencies (frozen lockfile)
        run: pnpm install --frozen-lockfile

      - name: üîß Install Cypress binary
        if: steps.cypress-cache.outputs.cache-hit != 'true'
        run: pnpm exec cypress install

      - name: üß™ Typecheck, Lint & Test
        run: pnpm run test:ci

      - name: üõ† Build library (production)
        run: pnpm run build

      - name: üßæ Version packages (apply changesets if present)
        run: pnpm changeset version || echo "No version changes"

      - name: üîÅ Reinstall after version bump (ensure lockfile integrity)
        run: pnpm install --frozen-lockfile

      - name: ‚¨ÜÔ∏è Commit and push version bump (tags stay in repo)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff-index --quiet HEAD || git commit -m "ci: version bump"
          git push

      - name: üöÄ Publish to npm (latest tag, public access)
        run: npm publish --access public

      - name: üìò Build Storybook (static export)
        run: pnpm run storybook:build

      - name: üìù Generate docs component overview
        run: cd docs && node scripts/generate-overview.mjs

      - name: üìö Build Docusaurus docs
        run: cd docs && pnpm build

      - name: üß± Assemble Pages site (docs root + storybook subpath)
        shell: bash
        run: |
          rm -rf site
          mkdir -p site/storybook

          # Docs become primary site at ui.prokodo.com
          cp -R docs/build/. site/

          # Storybook is served under /storybook
          cp -R storybook-static/. site/storybook/

          # Root entrypoint should open docs
          cat > site/index.html << 'EOF'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="utf-8" />
              <meta http-equiv="refresh" content="0; url=/docs/" />
              <meta name="viewport" content="width=device-width, initial-scale=1" />
              <title>prokodo UI</title>
            </head>
            <body>
              <p>Redirecting to <a href="/docs/">/docs/</a>‚Ä¶</p>
            </body>
          </html>
          EOF

          # Ensure custom domain for GitHub Pages
          echo 'ui.prokodo.com' > site/CNAME

      - name: üåê Deploy UI docs + Storybook to GitHub Pages (ui.prokodo.com)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          cname: ui.prokodo.com
